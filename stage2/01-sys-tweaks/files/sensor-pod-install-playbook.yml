---
- hosts: 127.0.0.1
  connection: local
  remote_user: root
  vars:
    gitPath: /git
    piGenPath: "{{ gitPath }}/pi-gen"

  tasks:
    - name: Install Apt Dependencies
      apt:
        name: "{{ packages }}"
      vars:
        packages:
        - python3-pip

    - name: Install Sensor Packages
      pip:
        executable: pip3
        name:
          - RPI.GPIO
          - adafruit_blinka
          - adafruit-circuitpython-ina219

    - name: Patch Boot Config
      patch:
        src: "/tmp/boot-config.txt.patch"
        dest: /boot/config.txt

    - name: Patch Bluetooth Config
      patch:
        src: /tmp/bluetooth.service.patch
        dest: /lib/systemd/system/bluetooth.service

    - name: Enable RFComm Service
      systemd:
        name: rfcomm
        enabled: yes

    - name: Reported OS Version
      command: cat /etc/os-release
      register: osinfo

    - debug: msg="{{ osinfo.stdout }}"

    - name: Run Pimoroni OnOffShim Installer
      command: bash -c 'cat /tmp/onoffshim.sh | bash -s -- -y'
      become: yes
      become_user: pi
